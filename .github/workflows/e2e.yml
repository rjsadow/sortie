name: E2E Tests

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  GO_VERSION: "1.24"
  NODE_VERSION: "22"

jobs:
  e2e:
    name: E2E Tests (Kind)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: web/package-lock.json

      - name: Install Kind
        run: |
          [ -f /usr/local/bin/kind ] || {
            curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.25.0/kind-linux-amd64
            chmod +x ./kind
            sudo mv ./kind /usr/local/bin/kind
          }

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Build application
        run: make build

      - name: Setup E2E cluster
        run: ./scripts/ci-e2e.sh setup

      - name: Run E2E tests
        run: go test -v -timeout 10m -count=1 ./tests/e2e/...

      - name: Collect logs on failure
        if: failure()
        run: ./scripts/ci-e2e.sh collect-logs

      - name: Upload E2E logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-logs
          path: /tmp/e2e-logs/
          retention-days: 7

      - name: Teardown cluster
        if: always()
        run: ./scripts/ci-e2e.sh teardown

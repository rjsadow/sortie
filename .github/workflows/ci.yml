name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  GO_VERSION: "1.25"
  NODE_VERSION: "22"

jobs:
  # Frontend build and lint
  frontend:
    name: Frontend Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Type check
        run: npx tsc -b --noEmit

      - name: Build
        run: npm run build

      - name: Upload frontend artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: web/dist
          retention-days: 1

  # Documentation site build
  docs:
    name: Docs Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: docs-site
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: docs-site/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Upload docs artifacts
        uses: actions/upload-artifact@v4
        with:
          name: docs-dist
          path: docs-site/dist
          retention-days: 1

  # Go lint with golangci-lint
  go-lint:
    name: Go Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Create placeholder web/dist for go:embed
        run: mkdir -p web/dist && touch web/dist/.gitkeep

      - name: Create placeholder docs-site/dist for go:embed
        run: mkdir -p docs-site/dist && touch docs-site/dist/.gitkeep

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v7
        with:
          version: latest

  # Go build and test
  go:
    name: Go Build
    runs-on: ubuntu-latest
    needs: [frontend, docs]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download frontend artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: web/dist

      - name: Download docs artifacts
        uses: actions/download-artifact@v4
        with:
          name: docs-dist
          path: docs-site/dist

      - name: Go mod tidy check
        run: |
          go mod tidy
          git diff --exit-code go.mod || (echo "go.mod is not tidy" && exit 1)
          if [ -f go.sum ]; then
            git diff --exit-code go.sum || (echo "go.sum is not tidy" && exit 1)
          fi

      - name: Go vet
        run: go vet ./...

      - name: Go build
        run: go build -v -o sortie .

      - name: Go test (unit)
        run: |
          go test -v -race -coverprofile=coverage.out \
            $(go list ./... | grep -v /tests/)

      - name: Upload Go coverage
        uses: actions/upload-artifact@v4
        with:
          name: go-coverage
          path: coverage.out
          retention-days: 7

  # Integration tests (full HTTP stack with mock runner)
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [frontend, docs]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download frontend artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: web/dist

      - name: Download docs artifacts
        uses: actions/download-artifact@v4
        with:
          name: docs-dist
          path: docs-site/dist

      - name: Run integration tests
        run: go test -v -race -timeout 5m -coverprofile=integration-coverage.out ./tests/integration/...

      - name: Upload integration coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-coverage
          path: integration-coverage.out
          retention-days: 7

  # Go unit tests against Postgres
  go-postgres:
    name: Go Tests (Postgres)
    runs-on: ubuntu-latest
    needs: [frontend, docs]
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: sortie_test
          POSTGRES_PASSWORD: sortie_test
          POSTGRES_DB: sortie_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download frontend artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: web/dist

      - name: Download docs artifacts
        uses: actions/download-artifact@v4
        with:
          name: docs-dist
          path: docs-site/dist

      - name: Go test (Postgres)
        env:
          SORTIE_TEST_DB_TYPE: postgres
          SORTIE_TEST_POSTGRES_DSN: postgres://sortie_test:sortie_test@localhost:5432/sortie_test?sslmode=disable
        run: |
          go test -v -race -p 1 -count=1 -coverprofile=coverage-postgres.out \
            $(go list ./... | grep -v /tests/)

      - name: Upload Postgres coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: go-postgres-coverage
          path: coverage-postgres.out
          retention-days: 7

  # Integration tests against Postgres
  integration-tests-postgres:
    name: Integration Tests (Postgres)
    runs-on: ubuntu-latest
    needs: [frontend, docs]
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: sortie_test
          POSTGRES_PASSWORD: sortie_test
          POSTGRES_DB: sortie_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download frontend artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: web/dist

      - name: Download docs artifacts
        uses: actions/download-artifact@v4
        with:
          name: docs-dist
          path: docs-site/dist

      - name: Run integration tests (Postgres)
        env:
          SORTIE_TEST_DB_TYPE: postgres
          SORTIE_TEST_POSTGRES_DSN: postgres://sortie_test:sortie_test@localhost:5432/sortie_test?sslmode=disable
        run: go test -v -race -p 1 -count=1 -timeout 5m -coverprofile=integration-coverage-postgres.out ./tests/integration/...

      - name: Upload integration coverage (Postgres)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-postgres-coverage
          path: integration-coverage-postgres.out
          retention-days: 7

  # Playwright E2E tests (browser-based frontend tests)
  playwright-e2e:
    name: Playwright E2E
    runs-on: ubuntu-latest
    needs: [frontend, docs]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: web/package-lock.json

      - name: Download frontend artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: web/dist

      - name: Download docs artifacts
        uses: actions/download-artifact@v4
        with:
          name: docs-dist
          path: docs-site/dist

      - name: Install Node dependencies
        run: npm --prefix web ci

      - name: Install Playwright browsers
        run: web/node_modules/.bin/playwright install --with-deps chromium firefox webkit

      - name: Build Go binary
        run: go build -o sortie .

      - name: Run Playwright tests
        run: web/node_modules/.bin/playwright test --config web/playwright.config.ts
        env:
          CI: true

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: web/playwright-report/
          retention-days: 7

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-test-results
          path: web/test-results/
          retention-days: 7

  # Full binary build via Makefile
  binary-build:
    name: Binary Build (Makefile)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: web/package-lock.json

      - name: Build via Makefile
        run: make build

      - name: Verify binary exists
        run: |
          test -f sortie || (echo "Binary not found" && exit 1)
          ./sortie -h || true

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: sortie-linux-amd64
          path: sortie
          retention-days: 7

  # Docker image build
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: sortie:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test Docker image
        run: |
          docker build -t sortie:test .
          docker run --rm -d -p 8080:8080 --name sortie-test sortie:test
          sleep 3
          curl -f http://localhost:8080/ || (docker logs sortie-test && exit 1)
          docker stop sortie-test

  # Security: Go vulnerability scanning
  go-security:
    name: Go Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          check-latest: true
          cache: true

      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Run govulncheck
        run: govulncheck ./...

  # Security: Frontend vulnerability scanning
  frontend-security:
    name: Frontend Security Scan
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=high

  # Security: Secret scanning
  secret-scan:
    name: Secret Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Markdown lint
  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Lint Markdown files
        uses: DavidAnson/markdownlint-cli2-action@v19
        with:
          globs: |
            docs-site/**/*.md
            agents/**/*.md
            *.md

  # Link check
  link-check:
    name: Link Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check links
        uses: lycheeverse/lychee-action@v2
        with:
          args: --no-progress --exclude localhost 'docs-site/**/*.md' '*.md'
          fail: true
          failIfEmpty: false

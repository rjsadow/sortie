# Sortie - Full Stack Docker Compose
#
# Deploy the full Sortie stack (backend + web + SQLite DB) in one command:
#
#   docker compose up -d
#
# The backend serves the embedded React frontend and uses SQLite for storage.
# No external database is required.
#
# Configuration:
#   Copy .env.example to .env and customize, or set environment variables below.
#
# Persistent data:
#   SQLite database is stored in a named volume (sortie-data).
#
# Note: Container session features (VNC/RDP streaming) require Kubernetes.
#   In Docker Compose mode, Sortie works as an application launcher
#   (URL-based apps) without container orchestration.

services:
  sortie:
    image: ghcr.io/rjsadow/sortie:latest
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "${SORTIE_PORT:-8080}:8080"
    environment:
      # --- Server ---
      SORTIE_PORT: "8080"
      SORTIE_DB: "/data/sortie.db"

      # --- Authentication (required) ---
      # Generate a secret: openssl rand -base64 32
      SORTIE_JWT_SECRET: "${SORTIE_JWT_SECRET:?Set SORTIE_JWT_SECRET (min 32 chars)}"
      SORTIE_ADMIN_USERNAME: "${SORTIE_ADMIN_USERNAME:-admin}"
      SORTIE_ADMIN_PASSWORD: "${SORTIE_ADMIN_PASSWORD:?Set SORTIE_ADMIN_PASSWORD}"
      SORTIE_JWT_ACCESS_EXPIRY: "${SORTIE_JWT_ACCESS_EXPIRY:-15}"
      SORTIE_JWT_REFRESH_EXPIRY: "${SORTIE_JWT_REFRESH_EXPIRY:-24}"
      SORTIE_ALLOW_REGISTRATION: "${SORTIE_ALLOW_REGISTRATION:-false}"

      # --- Branding (optional) ---
      SORTIE_TENANT_NAME: "${SORTIE_TENANT_NAME:-Sortie}"
      SORTIE_PRIMARY_COLOR: "${SORTIE_PRIMARY_COLOR:-#398D9B}"
      SORTIE_SECONDARY_COLOR: "${SORTIE_SECONDARY_COLOR:-#4AB7C3}"

      # --- Sessions (optional, only relevant with Kubernetes) ---
      SORTIE_SESSION_TIMEOUT: "${SORTIE_SESSION_TIMEOUT:-120}"
      SORTIE_SESSION_CLEANUP_INTERVAL: "${SORTIE_SESSION_CLEANUP_INTERVAL:-5}"
    volumes:
      - sortie-data:/data
    # Health endpoints (for external monitoring / load balancers):
    #   Liveness:  GET http://localhost:8080/healthz
    #   Readiness: GET http://localhost:8080/readyz
    restart: unless-stopped
    read_only: true
    tmpfs:
      - /tmp
    security_opt:
      - no-new-privileges:true

volumes:
  sortie-data:
    driver: local
